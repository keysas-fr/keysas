name: Generate the SBOM and deploy it to GitHub Pages

on:
  push:
    branches: [Develop, main]
  workflow_dispatch:

jobs:
  generate-sbom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: true

      - name: Install cyclonedx-bom
        run: cargo install cargo-cyclonedx

      - name: Generate SBOM XML
        run: |
          cargo cyclonedx
          mv keysas-core/keysas-core.cdx.xml sbom/keysas-core.cdx.xml
          mv keysas-backend/keysas-backend.cdx.xml sbom/keysas-backend.cdx.xml
          mv keysas-io/keysas-io.cdx.xml sbom/keysas-io.cdx.xml
          mv keysas-fido/keysas-fido.cdx.xml sbom/keysas-fido.cdx.xml
          mv keysas-sign/keysas-sign.cdx.xml sbom/keysas-sign.cdx.xml
          mv keysas_lib/keysas_lib.cdx.xml sbom/keysas_lib.cdx.xml
          
      - name: Add XSLT to SBOM XML
        run: |
          sed -i '1 a <?xml-stylesheet type="text/xsl" href="cyclonedx-to-html.xsl"?>' sbom/keysas-backend.cdx.xml
          sed -i '1 a <?xml-stylesheet type="text/xsl" href="cyclonedx-to-html.xsl"?>' sbom/keysas-core.cdx.xml
          sed -i '1 a <?xml-stylesheet type="text/xsl" href="cyclonedx-to-html.xsl"?>' sbom/keysas-fido.cdx.xml
          sed -i '1 a <?xml-stylesheet type="text/xsl" href="cyclonedx-to-html.xsl"?>' sbom/keysas-io.cdx.xml
          sed -i '1 a <?xml-stylesheet type="text/xsl" href="cyclonedx-to-html.xsl"?>' sbom/keysas_lib.cdx.xml
          sed -i '1 a <?xml-stylesheet type="text/xsl" href="cyclonedx-to-html.xsl"?>' sbom/keysas-sign.cdx.xml

      - name: Generate index.html
        run: |
          echo "<h1>SBOM files</h1><ul>" > sbom/index.html
          for file in sbom/*.xml; do
            name=$(basename "$file")
            echo "<li><a href='$name'>$name</a></li>" >> sbom/index.html
          done
          echo "</ul>" >> sbom/index.html

      - name: Define output folder based on branch
        run: |
          mkdir -p output
          cp -r sbom "output/${GITHUB_REF##*/}"

      - name: Deploy on GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          keep_files: true
          publish_dir: ./output
